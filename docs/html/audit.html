<!DOCTYPE html>
<html lang="ja" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›£æŸ»ãƒ­ã‚° (AuditLog) è§£èª¬ - Laravel</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-base-200">
    <!-- Navbar -->
    <div class="navbar bg-base-100 shadow-lg">
        <div class="flex-1">
            <a href="index.html" class="btn btn-ghost text-xl">ğŸ“š Laravel ãƒ†ã‚¹ãƒˆãƒ»ç›£æŸ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a>
        </div>
        <div class="flex-none">
            <ul class="menu menu-horizontal px-1">
                <li><a href="index.html">ãƒ›ãƒ¼ãƒ </a></li>
                <li><a href="phpunit.html">PHPUnit</a></li>
                <li><a href="dusk.html">Laravel Dusk</a></li>
                <li><a href="audit.html" class="font-bold text-accent">ç›£æŸ»ãƒ­ã‚°</a></li>
            </ul>
        </div>
    </div>

    <!-- Header -->
    <div class="bg-gradient-to-r from-accent to-warning py-16">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-4xl font-bold text-white mb-4">ğŸ“ ç›£æŸ»ãƒ­ã‚° (Audit Log)</h1>
            <p class="text-white/80">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚’è¨˜éŒ²ã—ã¦ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ã¨èª¬æ˜è²¬ä»»ã‚’ç¢ºä¿</p>
        </div>
    </div>

    <div class="container mx-auto px-4 py-12">

        <!-- What is Audit Log -->
        <div class="card bg-base-100 shadow-xl mb-12">
            <div class="card-body">
                <h2 class="card-title text-2xl mb-6">ğŸ” ç›£æŸ»ãƒ­ã‚°ã¨ã¯ï¼Ÿ</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-bold mb-4">å®šç¾©</h3>
                        <p class="mb-4">
                            ã‚·ã‚¹ãƒ†ãƒ å†…ã§ã€Œèª°ãŒã€ã€Œã„ã¤ã€ã€Œä½•ã‚’ã€ã€Œã©ã®ã‚ˆã†ã«å¤‰æ›´ã—ãŸã‹ã€ã‚’è¨˜éŒ²ã™ã‚‹ãƒ­ã‚°ã€‚
                            ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã€ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã€éšœå®³èª¿æŸ»ã«å¿…é ˆã€‚
                        </p>

                        <div class="alert alert-success">
                            <span>ğŸ’¡ åˆ¥å: ç›£æŸ»è¨¼è·¡ (Audit Trail)ã€å¤‰æ›´å±¥æ­´</span>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold mb-4">è¨˜éŒ²ã™ã‚‹è¦ç´ </h3>
                        <ul class="space-y-2">
                            <li class="flex items-center gap-2">
                                <span class="badge badge-primary">WHO</span>
                                èª°ãŒæ“ä½œã—ãŸã‹ (actor_id)
                            </li>
                            <li class="flex items-center gap-2">
                                <span class="badge badge-secondary">WHEN</span>
                                ã„ã¤æ“ä½œã—ãŸã‹ (created_at)
                            </li>
                            <li class="flex items-center gap-2">
                                <span class="badge badge-accent">WHAT</span>
                                ä½•ã‚’æ“ä½œã—ãŸã‹ (entity_type, entity_id)
                            </li>
                            <li class="flex items-center gap-2">
                                <span class="badge badge-info">HOW</span>
                                ã©ã†å¤‰æ›´ã—ãŸã‹ (action, meta)
                            </li>
                            <li class="flex items-center gap-2">
                                <span class="badge badge-warning">WHERE</span>
                                ã©ã“ã‹ã‚‰æ“ä½œã—ãŸã‹ (ip, user_agent)
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Flow Diagram -->
        <div class="card bg-base-100 shadow-xl mb-12">
            <div class="card-body">
                <h2 class="card-title text-2xl mb-6">ğŸ”„ ç›£æŸ»ãƒ­ã‚°ã®æµã‚Œ</h2>

                <div class="bg-base-200 p-8 rounded-xl">
                    <div class="flex flex-col lg:flex-row items-center justify-center gap-6">

                        <!-- User Action -->
                        <div class="flex flex-col items-center">
                            <div
                                class="w-36 h-28 bg-info text-info-content rounded-lg flex flex-col items-center justify-center p-4">
                                <div class="text-3xl">ğŸ‘¤</div>
                                <div class="font-bold text-sm">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ</div>
                            </div>
                            <div class="mt-2 text-xs">ãƒã‚±ãƒƒãƒˆä½œæˆ</div>
                        </div>

                        <div class="text-3xl hidden lg:block">â†’</div>
                        <div class="text-3xl lg:hidden">â†“</div>

                        <!-- Livewire Component -->
                        <div class="flex flex-col items-center">
                            <div
                                class="w-36 h-28 bg-primary text-primary-content rounded-lg flex flex-col items-center justify-center p-4">
                                <div class="text-3xl">âš¡</div>
                                <div class="font-bold text-sm">Livewire</div>
                            </div>
                            <div class="mt-2 text-xs">Tickets/Create</div>
                        </div>

                        <div class="text-3xl hidden lg:block">â†’</div>
                        <div class="text-3xl lg:hidden">â†“</div>

                        <!-- Service Layer -->
                        <div class="flex flex-col items-center">
                            <div
                                class="w-36 h-28 bg-secondary text-secondary-content rounded-lg flex flex-col items-center justify-center p-4 border-4 border-warning">
                                <div class="text-3xl">ğŸ”§</div>
                                <div class="font-bold text-sm">TicketService</div>
                            </div>
                            <div class="mt-2 text-xs font-bold text-warning">ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²</div>
                        </div>

                        <div class="text-3xl hidden lg:block">â†’</div>
                        <div class="text-3xl lg:hidden">â†“</div>

                        <!-- Audit Service -->
                        <div class="flex flex-col items-center">
                            <div
                                class="w-36 h-28 bg-accent text-accent-content rounded-lg flex flex-col items-center justify-center p-4">
                                <div class="text-3xl">ğŸ“</div>
                                <div class="font-bold text-sm">AuditService</div>
                            </div>
                            <div class="mt-2 text-xs">record()</div>
                        </div>

                        <div class="text-3xl hidden lg:block">â†’</div>
                        <div class="text-3xl lg:hidden">â†“</div>

                        <!-- Database -->
                        <div class="flex flex-col items-center">
                            <div
                                class="w-36 h-28 bg-warning text-warning-content rounded-lg flex flex-col items-center justify-center p-4">
                                <div class="text-3xl">ğŸ—„ï¸</div>
                                <div class="font-bold text-sm">audit_logs</div>
                            </div>
                            <div class="mt-2 text-xs">æ°¸ç¶šåŒ–</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Schema -->
        <div class="card bg-base-100 shadow-xl mb-12">
            <div class="card-body">
                <h2 class="card-title text-2xl mb-6">ğŸ—ƒï¸ audit_logs ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ </h2>

                <div class="overflow-x-auto">
                    <table class="table table-zebra">
                        <thead>
                            <tr>
                                <th>ã‚«ãƒ©ãƒ </th>
                                <th>å‹</th>
                                <th>èª¬æ˜</th>
                                <th>ä¾‹</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>id</code></td>
                                <td>UUID</td>
                                <td>ä¸»ã‚­ãƒ¼</td>
                                <td>550e8400-e29b...</td>
                            </tr>
                            <tr>
                                <td><code>tenant_id</code></td>
                                <td>UUID (FK)</td>
                                <td>ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢</td>
                                <td>ãƒ†ãƒŠãƒ³ãƒˆã®ID</td>
                            </tr>
                            <tr class="text-success">
                                <td><code>actor_id</code></td>
                                <td>UUID (FK)</td>
                                <td>æ“ä½œè€…ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰</td>
                                <td>users.id</td>
                            </tr>
                            <tr class="text-warning">
                                <td><code>action</code></td>
                                <td>VARCHAR</td>
                                <td>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç¨®åˆ¥</td>
                                <td>ticket.create</td>
                            </tr>
                            <tr class="text-info">
                                <td><code>entity_type</code></td>
                                <td>VARCHAR</td>
                                <td>å¯¾è±¡ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£</td>
                                <td>Ticket</td>
                            </tr>
                            <tr class="text-info">
                                <td><code>entity_id</code></td>
                                <td>UUID</td>
                                <td>å¯¾è±¡ã®ID</td>
                                <td>tickets.id</td>
                            </tr>
                            <tr>
                                <td><code>request_id</code></td>
                                <td>UUID</td>
                                <td>ãƒªã‚¯ã‚¨ã‚¹ãƒˆè¿½è·¡</td>
                                <td>X-Request-Id</td>
                            </tr>
                            <tr>
                                <td><code>ip</code></td>
                                <td>VARCHAR</td>
                                <td>IPã‚¢ãƒ‰ãƒ¬ã‚¹</td>
                                <td>192.168.1.1</td>
                            </tr>
                            <tr>
                                <td><code>user_agent</code></td>
                                <td>TEXT</td>
                                <td>ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±</td>
                                <td>Mozilla/5.0...</td>
                            </tr>
                            <tr class="text-accent">
                                <td><code>meta</code></td>
                                <td>JSONB</td>
                                <td>è¿½åŠ æƒ…å ±</td>
                                <td>{"from": "new", "to": "in_progress"}</td>
                            </tr>
                            <tr>
                                <td><code>created_at</code></td>
                                <td>TIMESTAMP</td>
                                <td>è¨˜éŒ²æ—¥æ™‚</td>
                                <td>2024-12-13 12:00:00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Code Implementation -->
        <div class="card bg-base-100 shadow-xl mb-12">
            <div class="card-body">
                <h2 class="card-title text-2xl mb-6">ğŸ’» å®Ÿè£…ã‚³ãƒ¼ãƒ‰</h2>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- AuditService -->
                    <div>
                        <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                            <span class="badge badge-accent">Service</span>
                            AuditService.php
                        </h3>
                        <div class="mockup-code text-sm">
                            <pre data-prefix="1"><code>class AuditService</code></pre>
                            <pre data-prefix="2"><code>{</code></pre>
                            <pre data-prefix="3" class="text-success"><code>    public function record(</code></pre>
                            <pre data-prefix="4"><code>        string $action,</code></pre>
                            <pre data-prefix="5"><code>        string $entityType,</code></pre>
                            <pre data-prefix="6"><code>        string $entityId,</code></pre>
                            <pre data-prefix="7"><code>        array $meta = []</code></pre>
                            <pre data-prefix="8"><code>    ): AuditLog {</code></pre>
                            <pre data-prefix="9"><code>        return AuditLog::create([</code></pre>
                            <pre data-prefix="10"><code>            'tenant_id' => Tenant::current()?->id,</code></pre>
                            <pre data-prefix="11"
                                class="text-warning"><code>            'actor_id' => auth()->id(),</code></pre>
                            <pre data-prefix="12"><code>            'action' => $action,</code></pre>
                            <pre data-prefix="13"><code>            'entity_type' => $entityType,</code></pre>
                            <pre data-prefix="14"><code>            'entity_id' => $entityId,</code></pre>
                            <pre data-prefix="15"><code>            'ip' => request()->ip(),</code></pre>
                            <pre data-prefix="16"><code>            'user_agent' => request()->userAgent(),</code></pre>
                            <pre data-prefix="17" class="text-info"><code>            'meta' => $meta,</code></pre>
                            <pre data-prefix="18"><code>        ]);</code></pre>
                            <pre data-prefix="19"><code>    }</code></pre>
                            <pre data-prefix="20"><code>}</code></pre>
                        </div>
                    </div>

                    <!-- Usage in TicketService -->
                    <div>
                        <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                            <span class="badge badge-secondary">ä½¿ç”¨ä¾‹</span>
                            TicketService.php
                        </h3>
                        <div class="mockup-code text-sm">
                            <pre data-prefix="1"><code>class TicketService</code></pre>
                            <pre data-prefix="2"><code>{</code></pre>
                            <pre
                                data-prefix="3"><code>    public function createTicket(array $data): Ticket</code></pre>
                            <pre data-prefix="4"><code>    {</code></pre>
                            <pre data-prefix="5"><code>        $ticket = Ticket::create($data);</code></pre>
                            <pre data-prefix="6"><code></code></pre>
                            <pre data-prefix="7" class="text-success"><code>        // ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²</code></pre>
                            <pre data-prefix="8"
                                class="text-success"><code>        $this->auditService->record(</code></pre>
                            <pre data-prefix="9" class="text-warning"><code>            'ticket.create',</code></pre>
                            <pre data-prefix="10"><code>            'Ticket',</code></pre>
                            <pre data-prefix="11"><code>            $ticket->id,</code></pre>
                            <pre data-prefix="12"
                                class="text-info"><code>            ['title' => $ticket->title]</code></pre>
                            <pre data-prefix="13"><code>        );</code></pre>
                            <pre data-prefix="14"><code></code></pre>
                            <pre data-prefix="15"><code>        return $ticket;</code></pre>
                            <pre data-prefix="16"><code>    }</code></pre>
                            <pre data-prefix="17"><code>}</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Types -->
        <div class="card bg-base-100 shadow-xl mb-12">
            <div class="card-body">
                <h2 class="card-title text-2xl mb-6">ğŸ“‹ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç¨®åˆ¥</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="card bg-success text-success-content">
                        <div class="card-body">
                            <h3 class="card-title text-lg">ticket.create</h3>
                            <p class="text-sm">ãƒã‚±ãƒƒãƒˆä½œæˆ</p>
                            <div class="mt-2 text-xs opacity-80">
                                meta: { title, type }
                            </div>
                        </div>
                    </div>

                    <div class="card bg-info text-info-content">
                        <div class="card-body">
                            <h3 class="card-title text-lg">ticket.assign</h3>
                            <p class="text-sm">æ‹…å½“è€…å¤‰æ›´</p>
                            <div class="mt-2 text-xs opacity-80">
                                meta: { old_assignee, new_assignee }
                            </div>
                        </div>
                    </div>

                    <div class="card bg-warning text-warning-content">
                        <div class="card-body">
                            <h3 class="card-title text-lg">ticket.status.transition</h3>
                            <p class="text-sm">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´</p>
                            <div class="mt-2 text-xs opacity-80">
                                meta: { from_status, to_status }
                            </div>
                        </div>
                    </div>

                    <div class="card bg-secondary text-secondary-content">
                        <div class="card-body">
                            <h3 class="card-title text-lg">ticket.comment</h3>
                            <p class="text-sm">ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ </p>
                            <div class="mt-2 text-xs opacity-80">
                                meta: { comment_id }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tenant Scoping -->
        <div class="card bg-base-100 shadow-xl mb-12">
            <div class="card-body">
                <h2 class="card-title text-2xl mb-6">ğŸ¢ ãƒ†ãƒŠãƒ³ãƒˆã‚¹ã‚³ãƒ¼ãƒ—</h2>

                <div class="alert alert-info mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        class="stroke-current shrink-0 w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <h3 class="font-bold">ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆç’°å¢ƒã§ã®åˆ†é›¢</h3>
                        <p>AuditLogãƒ¢ãƒ‡ãƒ«ã¯<code>HasTenantScope</code>ãƒˆãƒ¬ã‚¤ãƒˆã‚’ä½¿ç”¨ã—ã€è‡ªå‹•çš„ã«ç¾åœ¨ã®ãƒ†ãƒŠãƒ³ãƒˆã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚Œã¾ã™ã€‚</p>
                    </div>
                </div>

                <div class="bg-base-200 p-6 rounded-xl">
                    <div class="flex flex-col lg:flex-row items-center justify-center gap-8">
                        <!-- Tenant A -->
                        <div class="border-2 border-primary rounded-xl p-6 w-64">
                            <h3 class="text-center font-bold text-primary mb-4">ğŸ¢ ãƒ†ãƒŠãƒ³ãƒˆA</h3>
                            <div class="space-y-2 text-sm">
                                <div class="bg-base-100 p-2 rounded">ticket.create #1</div>
                                <div class="bg-base-100 p-2 rounded">ticket.assign #1</div>
                                <div class="bg-base-100 p-2 rounded">ticket.comment #1</div>
                            </div>
                        </div>

                        <div class="text-4xl">ğŸ”’</div>

                        <!-- Tenant B -->
                        <div class="border-2 border-secondary rounded-xl p-6 w-64">
                            <h3 class="text-center font-bold text-secondary mb-4">ğŸ¢ ãƒ†ãƒŠãƒ³ãƒˆB</h3>
                            <div class="space-y-2 text-sm">
                                <div class="bg-base-100 p-2 rounded">ticket.create #2</div>
                                <div class="bg-base-100 p-2 rounded">ticket.status #2</div>
                            </div>
                        </div>
                    </div>

                    <p class="text-center mt-6 text-sm opacity-70">
                        å„ãƒ†ãƒŠãƒ³ãƒˆã¯è‡ªåˆ†ã®ãƒ­ã‚°ã—ã‹è¦‹ãˆãªã„ï¼ˆè‡ªå‹•ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼‰
                    </p>
                </div>
            </div>
        </div>

        <!-- Best Practices -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-2xl mb-6">âœ… ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="alert alert-success">
                        <div>
                            <h3 class="font-bold">âœ“ Serviceå±¤ã§è¨˜éŒ²</h3>
                            <p class="text-sm">ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¨ä¸€ç·’ã«è¨˜éŒ²ã™ã‚‹ã“ã¨ã§æ¼ã‚Œã‚’é˜²ã</p>
                        </div>
                    </div>

                    <div class="alert alert-success">
                        <div>
                            <h3 class="font-bold">âœ“ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åã‚’çµ±ä¸€</h3>
                            <p class="text-sm"><code>entity.action</code>å½¢å¼ï¼ˆä¾‹: ticket.createï¼‰</p>
                        </div>
                    </div>

                    <div class="alert alert-success">
                        <div>
                            <h3 class="font-bold">âœ“ å¤‰æ›´å‰å¾Œã‚’è¨˜éŒ²</h3>
                            <p class="text-sm">metaã« from/to ã®å€¤ã‚’å«ã‚ã‚‹</p>
                        </div>
                    </div>

                    <div class="alert alert-success">
                        <div>
                            <h3 class="font-bold">âœ“ å‰Šé™¤ç¦æ­¢</h3>
                            <p class="text-sm">ç›£æŸ»ãƒ­ã‚°ã¯æ”¹ã–ã‚“é˜²æ­¢ã®ãŸã‚å‰Šé™¤ã—ãªã„</p>
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <div>
                            <h3 class="font-bold">âš  æ©Ÿå¯†æƒ…å ±ã«æ³¨æ„</h3>
                            <p class="text-sm">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç­‰ã¯metaã«å«ã‚ãªã„</p>
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <div>
                            <h3 class="font-bold">âš  ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h3>
                            <p class="text-sm">å¤§é‡æ›¸ãè¾¼ã¿æ™‚ã¯Queueä½¿ç”¨ã‚’æ¤œè¨</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer footer-center p-10 bg-base-300 text-base-content mt-12">
        <aside>
            <p>OpsHub ãƒ†ã‚¹ãƒˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ - ç›£æŸ»ãƒ­ã‚°ç·¨</p>
        </aside>
    </footer>
</body>

</html>