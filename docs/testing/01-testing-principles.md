# 01 テスト方針（AI開発に強い設計）

## 1. コア思想
- **テスト = 受け入れ条件（Doneの定義）**
- AIにとって重要なのは「最適解」より「**収束しやすい一本道**」
- したがってテストは **壊れたら困る仕様を固定**し、UI表現などは過度に固定しない

## 2. テストピラミッド（推奨）
優先度が高い順（AI向けに、ここが崩れると迷走しやすい）

1) **Unit（ドメインルール）**  
   - 状態遷移、権限判定、テナント境界のルール、入力バリデーションの純粋関数化  
   - 実行が速く、失敗原因が明確

2) **Feature（HTTP/認証/認可/DB）**  
   - 主要なユーザーフローだけ（数は絞る）  
   - 例: チケット作成→アサイン→状態変更→監査ログ作成

3) **Livewire Component Test**  
   - UIの状態管理はLivewire側に寄るため、ここは「壊れやすいコンポーネント」だけ

4) **E2E（Playwright）**  
   - 数本で十分（ログイン、主要フロー、権限制御の視覚確認）  
   - 目的: リグレッションの早期検知＋“本当に動く”の担保

## 3. TDDの運用指針（AI前提）
- **Red → Green → Refactor** を必ず回す
- 1コミット（または1PR）でやることを小さくする
- 「テストが通ること」を最終合格にするが、**テストが壊れやすい書き方**は避ける

### AIへの指示テンプレ（運用）
- 変更対象
- 受け入れ条件（Given/When/Then）
- 追加/変更するテスト一覧（テスト名まで）
- 失敗時は “原因候補トップ3＋検証手順” を出させる（無限ループ防止）

## 4. “固定すべき仕様” と “固定しすぎない仕様”
固定すべき（テストに書く）
- テナントAのユーザーがテナントBのデータに触れない
- RBAC（role/permission）により操作可否が決まる
- Ticketの状態遷移がルールに従う
- 重要操作が監査ログに残る
- 例外時は request_id が出る / 失敗ジョブが記録される

固定しすぎない（テストに書きすぎない）
- ボタンの文言、細かいHTML構造、CSSクラス（daisyUIの内部変更に弱い）
- 画面レイアウトの細部（E2Eでも必要最低限に）
